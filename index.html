<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº‘è½å›¾åºŠ</title>
    <link rel="stylesheet" href="https://fonts.font.im/icon?family=Material+Icons|Material+Icons+Outlined">
    <link rel="preconnect" href="https://fonts.font.im">
    <script src="https://fastly.jsdelivr.net/npm/js-sha256@0.9.0/src/sha256.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="./memorial-data.js"></script>
    <style>
        /* --- å…¨å±€ä¼˜åŒ–ä¸é‡ --- */
        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç§»åŠ¨ç«¯ç‚¹å‡»è“è‰²é«˜äº® */
        }

        :root {
            /* æ­£å¸¸æ¨¡å¼é…è‰² */
            --md-sys-color-primary: #0061a4;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d1e4ff;
            --md-sys-color-on-primary-container: #001d36;
            --md-sys-color-background: #f8f9fc;
            --md-sys-color-on-background: #1a1c1e;
            --md-sys-color-surface: #fdfcff;
            --md-sys-color-on-surface: #1a1c1e;
            --md-sys-color-surface-variant: #dfe3eb;
            --md-sys-color-on-surface-variant: #42474e;
            --md-sys-color-outline: #e0e2e8;
            --md-sys-color-error: #ba1a1a;
            --md-sys-color-success: #386a1e;
            --transition-fast: 0.2s ease;
            --transition-medium: 0.3s ease;
        }

        body.dark-mode {
            /* æ­£å¸¸æ¨¡å¼-æ·±è‰²é…è‰² */
            --md-sys-color-primary: #9ecaff;
            --md-sys-color-on-primary: #003258;
            --md-sys-color-primary-container: #00497d;
            --md-sys-color-on-primary-container: #d1e4ff;
            --md-sys-color-background: #1a1c1e;
            --md-sys-color-on-background: #e2e2e6;
            --md-sys-color-surface: #25282d;
            --md-sys-color-on-surface: #e2e2e6;
            --md-sys-color-surface-variant: #42474e;
            --md-sys-color-on-surface-variant: #c2c7cf;
            --md-sys-color-outline: #3f4146;
            --md-sys-color-error: #ffb4ab;
            --md-sys-color-success: #a2d192;
        }
        
        /* --- æ‚¼å¿µæ¨¡å¼ï¼ˆç°è‰²ï¼‰é…è‰²æ–¹æ¡ˆ - ä¼˜åŒ–åï¼Œæ›´æŠ¤çœ¼ --- */
        body.grayscale-mode, body.grayscale-mode.dark-mode {
            /* æµ…è‰²èƒŒæ™¯ï¼šé«˜å¯¹æ¯”åº¦ã€æŠ¤çœ¼ç° */
            --md-sys-color-background: #f5f5f5; /* æŸ”å’Œæµ…ç° */
            --md-sys-color-on-background: #212121; /* è¿‘é»‘ï¼Œé«˜å¯¹æ¯”åº¦ */
            
            --md-sys-color-surface: #ffffff; /* å¡ç‰‡èƒŒæ™¯ï¼šçº¯ç™½ï¼Œçªå‡ºå†…å®¹ */
            --md-sys-color-on-surface: #212121;
            --md-sys-color-surface-variant: #ededed; /* é»˜è®¤å¡ç‰‡èƒŒæ™¯è‰²/è¾“å…¥æ¡†èƒŒæ™¯ */
            --md-sys-color-on-surface-variant: #616161; /* æ¬¡çº§æ–‡æœ¬/å›¾æ ‡ */
            
            --md-sys-color-primary: #757575; /* ä¸»è¦æ“ä½œ/æŒ‰é’®ï¼šä¸­ç°ï¼Œåº„é‡ */
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #e0e0e0; /* æµ…ç°å®¹å™¨ */
            --md-sys-color-on-primary-container: #424242;
            
            --md-sys-color-outline: #bdbdbd; /* è¾¹æ¡†/åˆ†å‰²çº¿ */
            --md-sys-color-error: #757575; /* ç°è‰²é”™è¯¯æç¤º */
            --md-sys-color-success: #757575; /* ç°è‰²æˆåŠŸæç¤º */
            
            /* filter: grayscale(100%); ç§»é™¤ä»¥ä¿è¯æ›´å¥½çš„ UI å…¼å®¹æ€§å’Œæ€§èƒ½ */
        }

        /* é’ˆå¯¹æ·±è‰²æ¨¡å¼çš„ç°è‰²å¾®è°ƒï¼Œä½¿å…¶åœ¨æ·±è‰²èƒŒæ™¯ä¸‹ä»ä¸ºç°è‰²ï¼Œä¸”ä¿æŒèˆ’é€‚å¯¹æ¯”åº¦ */
        body.grayscale-mode.dark-mode {
            --md-sys-color-background: #252525; /* æŸ”å’Œæ·±ç° */
            --md-sys-color-on-background: #e0e0e0;
            
            --md-sys-color-surface: #363636;
            --md-sys-color-on-surface: #e0e0e0;
            --md-sys-color-surface-variant: #4a4a4a;
            --md-sys-color-on-surface-variant: #a0a0a0;
            
            --md-sys-color-primary: #9e9e9e; /* ä¸­æ€§ç°ï¼Œä½œä¸ºä¸»è¦è‰² */
            --md-sys-color-on-primary: #121212;
            --md-sys-color-primary-container: #616161;
            --md-sys-color-on-primary-container: #d3d3d3;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            transition: background-color var(--transition-medium);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* --- æ‚¼å¿µæ¨ªå¹…æ ·å¼ (æ–°å¢ Flex å¸ƒå±€å’Œå…³é—­æŒ‰é’®æ ·å¼ï¼Œä¼˜åŒ–ä¸ºé€šçŸ¥èƒ¶å›Š) --- */
        #memorialBanner {
            display: flex; /* ä½¿ç”¨ Flex å¸ƒå±€ */
            justify-content: center; /* å†…å®¹å±…ä¸­ */
            align-items: center; /* å‚ç›´å±…ä¸­ */
            /* é‡‡ç”¨ on-background / background çš„é«˜å¯¹æ¯”åº¦ï¼Œç¡®ä¿æ¨ªå¹…æ¸…æ™° */
            /* åˆå§‹å€¼å°†ç”± JS è¦†ç›–ä¸º memorial-data.js ä¸­çš„ bannerStyle */
            background-color: var(--md-sys-color-on-background); 
            color: var(--md-sys-color-background);
            text-align: center;
            padding: 8px 16px; /* èƒ¶å›Šå¼å†…è¾¹è· */
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 1px;
            z-index: 1000;
            margin-bottom: 16px;
            position: sticky;
            top: 0;
            width: fit-content;
            margin: 8px auto;
            border-radius: 100px; /* èƒ¶å›Šå½¢çŠ¶ */
            transition: background-color var(--transition-medium), color var(--transition-medium);
            cursor: pointer; /* ä¿®å¤ï¼šå¢åŠ æŒ‡é’ˆæ ·å¼ */
        }
        
        #memorialBannerText {
            flex-grow: 1; /* è®©æ–‡æœ¬å æ®å‰©ä½™ç©ºé—´ */
            margin-right: 16px; /* ä¸å…³é—­æŒ‰é’®ä¿æŒè·ç¦» */
        }

        #closeMemorialButton {
            background: none;
            border: none;
            color: inherit; /* ç»§æ‰¿æ¨ªå¹…çš„æ–‡æœ¬é¢œè‰² */
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: background-color var(--transition-fast);
            line-height: 1;
            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
        }

        #closeMemorialButton:hover {
            background-color: rgba(255, 255, 255, 0.1); /* é¼ æ ‡æ‚¬åœæ•ˆæœ */
        }
        
        #closeMemorialButton .material-icons {
            font-size: 20px;
            vertical-align: middle;
        }

        #memorialIcon {
            font-size: 20px;
            margin-right: 8px;
        }

        /* --- å¸ƒå±€ä¸å¡ç‰‡ï¼ˆå…¶ä½™æ ·å¼ä¿æŒä¸å˜æˆ–è·Ÿéšvar()è‡ªåŠ¨å˜è‰²ï¼‰ --- */
        .container { width: 100%; max-width: 640px; margin: 0 auto; padding: 16px; }
        .app-bar { display: flex; justify-content: space-between; align-items: center; padding: 12px 4px; background-color: rgba(var(--md-sys-color-surface), 0.8); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 10; }
        h1 { font-size: 24px; font-weight: 700; color: var(--md-sys-color-primary); margin: 0; }
        .main-content { display: flex; flex-direction: column; gap: 16px; }
        .card { background-color: var(--md-sys-color-surface); border-radius: 24px; padding: 20px; border: 1px solid var(--md-sys-color-outline); transition: background-color var(--transition-medium), border-color var(--transition-medium); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Softer shadows */ }

        .card-title { font-size: 14px; font-weight: 600; color: var(--md-sys-color-primary); margin: 0 0 16px 0; padding-left: 4px; display: flex; align-items: center; justify-content: space-between; }

        /* --- åŸç”Ÿ UI ç»„ä»¶é‡ç»˜ (æ€§èƒ½ä¼˜åŒ–ç‰ˆ) --- */
        .btn { display: inline-flex; align-items: center; justify-content: center; border: none; cursor: pointer; user-select: none; text-decoration: none; font-size: 14px; font-weight: 600; text-transform: none; border-radius: 100px; height: 48px; padding: 0 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: background-color var(--transition-fast), box-shadow var(--transition-fast), transform var(--transition-fast); background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant); flex: 1; } /* ä¿®å¤ï¼šæ·»åŠ  flex:1 ç¡®ä¿æŒ‰é’®å‡åŒ€åˆ†å¸ƒ */
        .btn:active { transform: scale(0.95); filter: brightness(0.95); } /* Micro scale on active */
        .btn-raised { background: linear-gradient(135deg, var(--md-sys-color-primary) 0%, hsl(from var(--md-sys-color-primary) h s calc(l - 10%)) 100%); color: var(--md-sys-color-on-primary); }
        .btn-block { width: 100%; }
        .btn-icon { width: 40px; height: 40px; min-width: 40px; padding: 0; border-radius: 50%; box-shadow: none; background: transparent; flex: none; } /* ä¿®å¤ï¼šå†å²æŒ‰é’®ä½¿ç”¨ flex: none */
        .btn-icon .material-icons { margin: 0; }
        .btn:disabled { background-color: var(--md-sys-color-surface-variant) !important; color: var(--md-sys-color-on-surface-variant) !important; opacity: 0.7; cursor: not-allowed; box-shadow: none; transform: none; filter: none; }
        
        .textfield { position: relative; margin: 16px 0; }
        .textfield-input { width: 100%; border: none; border-bottom: 1px solid var(--md-sys-color-on-surface-variant); padding: 8px 0; font-size: 16px; background-color: transparent; color: var(--md-sys-color-on-background); transition: border-bottom var(--transition-fast); }
        .textfield-input:focus { outline: none; border-bottom: 2px solid var(--md-sys-color-primary); }
        .textfield-label { position: absolute; left: 0; top: 8px; pointer-events: none; color: var(--md-sys-color-on-surface-variant); transition: all var(--transition-fast); }
        .textfield-input:focus + .textfield-label, .textfield-input:not(:placeholder-shown) + .textfield-label { top: -16px; font-size: 12px; color: var(--md-sys-color-primary); }

        .progress-container { width: 100%; height: 4px; background-color: var(--md-sys-color-surface-variant); border-radius: 4px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background-color: var(--md-sys-color-primary); transition: width var(--transition-medium); }

        .chip-group { display: flex; gap: 8px; margin-bottom: 16px; padding: 4px; background-color: var(--md-sys-color-surface-variant); border-radius: 12px; }
        .chip { flex: 1; background-color: transparent; color: var(--md-sys-color-on-surface-variant); font-weight: 500; cursor: pointer; transition: all var(--transition-fast); height: 40px; line-height: 40px; padding: 0 8px; border-radius: 10px; text-align: center; user-select: none; }
        .chip.active { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        .dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity var(--transition-medium); }
        .dialog-overlay.visible { opacity: 1; visibility: visible; }
        .dialog { position: fixed; top: 50%; left: 50%; background-color: rgba(var(--md-sys-color-surface), 0.8); backdrop-filter: blur(12px); color: var(--md-sys-color-on-surface); border-radius: 28px; width: calc(100% - 32px); max-width: 560px; z-index: 1001; transform: translate(-50%, -50%) scale(0.95); opacity: 0; visibility: hidden; transition: all var(--transition-medium); }
        .dialog-overlay.visible .dialog { transform: translate(-50%, -50%) scale(1); opacity: 1; visibility: visible; }
        .dialog-title { font-size: 22px; font-weight: 600; padding: 24px 24px 16px; }
        .dialog-content { padding: 0 24px 24px; color: var(--md-sys-color-on-surface-variant); line-height: 1.6; }
        /* æ ¸å¿ƒä¿®å¤æ ·å¼ï¼šè®©å¯¹è¯æ¡†å†…å®¹å¯æ»šåŠ¨ */
        .dialog-scrollable .dialog-content {
            max-height: 70vh; /* è®¾ç½®æœ€å¤§é«˜åº¦ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´ */
            overflow-y: auto; /* å…è®¸å‚ç›´æ»šåŠ¨ */
            padding-right: 16px; /* ä¸ºæ»šåŠ¨æ¡ç•™å‡ºç©ºé—´ */
        }
        .dialog-actions { padding: 8px 16px 16px; display: flex; justify-content: flex-end; gap: 8px; }
        .dialog-actions .btn { background: none; box-shadow: none; color: var(--md-sys-color-primary); height: 40px; flex: none; } /* ä¿®å¤ï¼šå¯¹è¯æ¡†æŒ‰é’® flex: none */
        .dialog ul { padding-left: 20px; margin-top: 8px; list-style-type: 'ğŸ‘‰ '; }
        .dialog ul li { padding-left: 8px; margin-bottom: 6px; }

        .dialog-bottom-sheet { top: auto; bottom: 0; left: 50%; transform: translate(-50%, 100%); border-radius: 28px 28px 0 0; }
        .dialog-overlay.visible .dialog-bottom-sheet { transform: translate(-50%, 0); }
        .dialog-bottom-sheet .dialog-title { padding-bottom: 8px; }
        .dialog-bottom-sheet .dialog-content { padding: 0 0 16px; }
        .list { list-style: none; padding: 0; margin: 0; }
        .list-item { display: flex; align-items: center; padding: 12px 24px; cursor: pointer; transition: background-color var(--transition-fast); }
        .list-item:active { background-color: rgba(0,0,0,0.05); }
        body.dark-mode .list-item:active { background-color: rgba(255,255,255,0.05); }
        .list-item-content { flex-grow: 1; pointer-events: none; } 
        .list-item-icon { margin-left: 16px; color: var(--md-sys-color-primary); pointer-events: none; }

        .snackbar { position: fixed; top: 16px; left: 50%; transform: translateX(-50%) translateY(-100px); background-color: #323232; color: #fff; padding: 14px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 2000; font-size: 14px; transition: transform var(--transition-medium); }
        body.dark-mode .snackbar { background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant); }
        .snackbar.visible { transform: translateX(-50%) translateY(0); }

        /* --- å†å²è®°å½•å¡ç‰‡æ ·å¼ (æ ¸å¿ƒä¿®å¤åŒº) --- */
        #historyList { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            gap: 8px; 
            transition: max-height 0.3s ease-out, padding-right 0.3s ease-out; /* ä¿®å¤: ç¡®ä¿è¿‡æ¸¡åº”ç”¨äºæœ€å¤§é«˜åº¦ */
        }
        
        /* ä¿®å¤: ç¡®ä¿ visible çŠ¶æ€æœ‰æ˜ç¡®çš„æœ€å¤§é«˜åº¦å’Œ overflow-y: auto */
        #historyList.visible { 
            max-height: 40vh; /* ä½¿ç”¨è§†çª—é«˜åº¦ç™¾åˆ†æ¯”ï¼Œæ›´å…·é€‚åº”æ€§ */
            overflow-y: auto; 
            padding-right: 8px; /* ä¸ºæ»šåŠ¨æ¡ç•™å‡ºç©ºé—´ï¼Œé˜²æ­¢å†…å®¹è¢«é®æŒ¡ */
        }
        
        /* ä¿®å¤: ç¡®ä¿ hidden çŠ¶æ€çš„ overflow-y ä¸º hidden */
        #historyList.hidden { 
            max-height: 0; 
            overflow-y: hidden; 
            padding-right: 0; /* æŠ˜å æ—¶ä¸éœ€è¦æ»šåŠ¨æ¡ç©ºé—´ */
        }
        
        #clearHistoryContainer {
             /* æ ¸å¿ƒä¿®å¤ 2: å¢åŠ ä¸ä¸Šæ–¹åˆ—è¡¨çš„é—´è· */
            margin-top: 16px;
        }

        /* Grid View for History */
        #historyList.grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }
        #historyList.grid .history-item {
            flex-direction: column;
            align-items: center;
        }
        #historyList.grid .history-item-thumb {
            width: 100%;
            height: auto;
        }
        #historyList.grid .history-item-info {
            text-align: center;
            margin-top: 4px;
        }
        #historyList.grid .history-item-actions {
            margin-top: 4px;
        }

        /* --- å…¶ä»–ç»„ä»¶æ ·å¼ (æ¥è‡ªåŸç‰ˆ + ä¼˜åŒ–) --- */
        .upload-area { background-color: var(--md-sys-color-primary-container); border: 2px dashed var(--md-sys-color-primary); border-radius: 20px; padding: 32px 16px; text-align: center; cursor: pointer; transition: background-color var(--transition-fast), transform var(--transition-fast); }
        .upload-area:hover { transform: scale(1.02); }
        .upload-area:active { transform: scale(1.01); }
        .upload-area.dragover { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); animation: breathe 1.5s ease-in-out infinite; }
        .upload-area .material-icons-outlined { font-size: 48px; color: var(--md-sys-color-primary); }
        .upload-area.dragover .material-icons-outlined, .upload-area.dragover .upload-tip { color: var(--md-sys-color-on-primary); }
        .upload-tip { color: var(--md-sys-color-on-primary-container); margin: 8px 0 16px; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 10px; } /* ä¼˜åŒ–: é¿å…é•¿æ–‡ä»¶åæ¢è¡Œ */
        #imageUpload { display: none; }
        .file-info { font-size: 14px; color: var(--md-sys-color-on-surface-variant); text-align: center; margin-top: 16px; word-break: break-all; }
        #imagePreview { width: 100%; height: auto; max-height: 200px; margin-top: 16px; border-radius: 16px; object-fit: contain; display: none; cursor: pointer; }
        #uploadProgressContainer { margin-top: 16px; display: none; }
        #resultUrl { background-color: var(--md-sys-color-surface-variant); border-radius: 12px; padding: 12px 16px; font-family: 'SF Mono', 'Consolas', monospace; word-break: break-all; color: var(--md-sys-color-on-surface-variant); border: none; margin-bottom: 16px; }
        .history-item { display: flex; align-items: center; padding: 12px; background-color: var(--md-sys-color-surface-variant); border-radius: 16px; transition: background-color var(--transition-fast), transform 0.3s ease; position: relative; overflow: hidden; }
        .history-item-thumb { width: 48px; height: 48px; border-radius: 12px; object-fit: cover; margin-right: 16px; flex-shrink: 0; background-color: var(--md-sys-color-outline); display: flex; align-items: center; justify-content: center; cursor: pointer;}
        .history-item-info { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px; cursor: pointer; }
        .history-item-info:active, .history-item-thumb:active { filter: brightness(0.9); }
        .history-item-actions { display: flex; gap: 8px; flex-shrink: 0; align-items: center; } /* ä¿®å¤ï¼šæ·»åŠ  align-items: center ç¡®ä¿å‚ç›´å¯¹é½ */
        .delete-button { flex-shrink: 0; }
        .swipe-delete { position: absolute; right: 0; height: 100%; background: var(--md-sys-color-error); color: white; border: none; padding: 0 16px; display: flex; align-items: center; transform: translateX(100%); transition: transform 0.3s; }
        .history-item.swiped .swipe-delete { transform: translateX(0); }
        #historyEmptyTip { text-align:center; color: var(--md-sys-color-on-surface-variant); padding: 20px 0; }
        #censorStatus { margin-top: 16px; padding: 12px; border-radius: 12px; font-weight: bold; text-align: center; display: none; }
        .censor-safe { background-color: var(--md-sys-color-success); color: var(--md-sys-color-on-primary); }
        .censor-warning { background-color: var(--md-sys-color-error); color: var(--md-sys-color-on-primary); }
        .censor-normal { background-color: var(--md-sys-color-surface-variant); color: var(--md-sys-color-on-surface-variant); }
        #yiyanContent { font-size: 16px; text-align: center; color: var(--md-sys-color-on-surface); margin: 0 0 8px; line-height: 1.6; }
        #yiyanFrom { font-size: 13px; text-align: center; color: var(--md-sys-color-on-surface-variant); margin: 0 0 16px; }
        .footer { text-align: center; font-size: 12px; color: var(--md-sys-color-on-surface-variant); padding: 24px 0; }
        .footer a { color: var(--md-sys-color-on-surface-variant); text-decoration: underline; }

        /* ä¿®å¤ï¼šç»“æœåŒºæŒ‰é’®å®¹å™¨ï¼Œç¡®ä¿å‡åŒ€åˆ†å¸ƒ */
        #resultArea .btn { flex: 1; min-width: 0; } /* ç¡®ä¿æŒ‰é’®åœ¨flexå®¹å™¨ä¸­å‡åŒ€ */
        .history-item-actions .btn-icon { flex: none; width: 36px; height: 36px; } /* ä¿®å¤å†å²æŒ‰é’®å¤§å°ä¸€è‡´ */

        /* Breathe Animation for Upload Area */
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Lightbox Overlay */
        .lightbox-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        /* FAB Style */
        #fab {
            position: fixed;
            bottom: 16px;
            right: 16px;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: none; /* Show on mobile via media query */
        }

        /* ä¼˜åŒ–ï¼šåª’ä½“æŸ¥è¯¢ä»¥é€‚åº”å¹³æ¿å’Œç”µè„‘ç«¯ */
        @media (min-width: 768px) { /* å¹³æ¿ */
            .container { max-width: 800px; padding: 24px; }
            .main-content { gap: 24px; }
            .card { padding: 24px; border-radius: 28px; }
            .app-bar { padding: 16px 8px; }
            h1 { font-size: 28px; }
            .upload-area { padding: 40px 24px; }
            .upload-area .material-icons-outlined { font-size: 56px; }
            #imagePreview { max-height: 300px; }
            #historyList.visible { max-height: 50vh; }
            .dialog { max-width: 640px; }
            .dialog-title { font-size: 24px; padding: 28px 28px 20px; }
            .dialog-content { padding: 0 28px 28px; }
            .snackbar { padding: 16px 28px; font-size: 15px; }
            .footer { font-size: 13px; padding: 32px 0; }
        }

        @media (min-width: 1024px) { /* ç”µè„‘ */
            .container { max-width: 960px; padding: 32px; }
            .main-content { gap: 32px; }
            .card { padding: 32px; border-radius: 32px; }
            .app-bar { padding: 20px 12px; }
            h1 { font-size: 32px; }
            .upload-area { padding: 48px 32px; }
            .upload-area .material-icons-outlined { font-size: 64px; }
            #imagePreview { max-height: 400px; }
            #historyList.visible { max-height: 60vh; }
            .dialog { max-width: 720px; }
            .dialog-title { font-size: 26px; padding: 32px 32px 24px; }
            .dialog-content { padding: 0 32px 32px; }
            .snackbar { padding: 18px 32px; font-size: 16px; }
            .footer { font-size: 14px; padding: 40px 0; }
        }

        @media (max-width: 600px) {
            #fab { display: inline-flex; }
        }
    </style>

</head>
<body>

    <div id="memorialBanner" style="display: none;">
        <i id="memorialIcon" class="material-icons">local_florist</i>
        <span id="memorialBannerText"></span>
        <button id="closeMemorialButton" title="å…³é—­æ‚¼å¿µæ¨¡å¼">
            <i class="material-icons">close</i>
        </button>
    </div> 

<div class="container">
    <header class="app-bar">
        <h1>äº‘è½å›¾åºŠ</h1>
        <button class="btn btn-icon" id="themeToggleButton">
            <i class="material-icons">brightness_2</i>
        </button>
    </header>

    <main class="main-content">
        <section class="card">
            <p class="card-title">æ¥å£è®¾ç½®</p>
            <button id="apiSelectorButton" class="api-selector-button">
                <span id="selectedApiName">é‡è¦</span>
                <i class="material-icons">arrow_drop_down</i>
            </button>
            <input type="hidden" id="apiSelector" value="yanxuan">
        </section>
        
        <section class="card">
            <p class="card-title">æ–‡ä»¶ä¸Šä¼ </p>
            <div id="uploadArea" class="upload-area">
                <i class="material-icons-outlined">upload_file</i>
                <p id="uploadTip" class="upload-tip">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–</p>
                <label for="imageUpload" class="btn btn-raised"><i class="material-icons">add_photo_alternate</i>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</label>
            </div>
            <input type="file" id="imageUpload">
            <p id="fileSizeTip" class="file-info"></p>
            <img id="imagePreview" src="" alt="å›¾ç‰‡é¢„è§ˆ">
            <div id="uploadProgressContainer">
                <div class="progress-container"><div class="progress-bar" id="uploadProgressBar"></div></div>
            </div>
            <div id="censorStatus"><i class="material-icons" style="vertical-align: middle;">security</i> <span>å›¾ç‰‡å®‰å…¨æ£€æŸ¥çŠ¶æ€</span></div>
            <p id="statusMessage"></p>
            <div id="uploadButtonContainer" style="margin-top: 16px;">
                <button id="uploadButton" class="btn btn-block btn-raised" disabled><i class="material-icons">backup</i>å¼€å§‹ä¸Šä¼ </button>
            </div>
        </section>
        
        <section class="card" id="resultArea" style="display: none;">
            <p class="card-title">ä¸Šä¼ æˆåŠŸ</p>
            <div class="chip-group" id="urlFormatSelector">
                <span class="chip active" data-format="url">URL</span>
                <span class="chip" data-format="markdown">Markdown</span>
                <span class="chip" data-format="html">HTML</span>
            </div>
            <div id="resultUrl"></div>
            <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button id="openUrlButton" class="btn"><i class="material-icons">open_in_new</i>æ‰“å¼€</button>
                <button id="copyUrlButton" class="btn btn-raised"><i class="material-icons">content_copy</i>å¤åˆ¶</button>
                <button id="enhanceImageButton" class="btn"><i class="material-icons">auto_fix_high</i>AI å¢å¼º</button>
                <button id="addWatermarkButton" class="btn" disabled><i class="material-icons">branding_watermark</i>æ·»åŠ æ°´å°</button>
            </div>
        </section>

        <section class="card">
            <p class="card-title">
                <span>ä¸Šä¼ å†å²</span>
                <button id="historyViewToggle" class="btn btn-icon" title="åˆ‡æ¢è§†å›¾"><i class="material-icons">grid_view</i></button>
                <button id="toggleHistoryButton" class="btn btn-icon" title="æŠ˜å /å±•å¼€å†å²è®°å½•"><i class="material-icons">keyboard_arrow_up</i></button>
            </p>
            <ul id="historyList" class="visible"></ul>
            <div id="clearHistoryContainer">
                <button id="clearHistoryButton" class="btn" style="display: none;"><i class="material-icons">delete_sweep</i>æ¸…ç©ºè®°å½•</button>
            </div>
        </section>

        <section class="card">
            <p id="yiyanContent"></p>
            <p id="yiyanFrom"></p>
            <div style="text-align: center;">
                <button id="refreshYiyanButton" class="btn"><i class="material-icons">refresh</i>æ¢ä¸€å¥</button>
            </div>
        </section>
    </main>
    
    <footer class="footer">
        <p>è”ç³»æ–¹å¼: <a href="mailto:jiayuxuan_2024@qq.com">jiayuxuan_2024@qq.com</a></p>
        <p>æœ¬ç«™ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨
        ã€‚æ¸©é¦¨æç¤ºï¼Œå¯ä»¥åŒå‡»æ¨ªå¹…æ˜¾ç¤ºæ›´å¤šçºªå¿µå½“æ—¥çºªå¿µäººç‰©</p>
        <div id="visitorCount"></div>
    </footer>

    <button id="fab" class="btn btn-raised"><i class="material-icons">add</i></button>
</div>

<script>
    // --- åŸç”Ÿ UI ç»„ä»¶é€»è¾‘ (æ€§èƒ½ä¼˜åŒ–ç‰ˆ) ---
    function showSnackbar(message) {
        const existing = document.querySelector('.snackbar');
        if (existing) existing.remove();
        const snackbar = document.createElement('div');
        snackbar.className = 'snackbar';
        snackbar.textContent = message;
        document.body.appendChild(snackbar);
        setTimeout(() => snackbar.classList.add('visible'), 10);
        setTimeout(() => {
            snackbar.classList.remove('visible');
            snackbar.addEventListener('transitionend', () => snackbar.remove(), { once: true });
        }, 3000);
    }
    
    /**
     * æ˜¾ç¤ºå¯¹è¯æ¡† (ä¼˜åŒ–ï¼šè¿”å›ä¸€ä¸ªå…³é—­å¥æŸ„)
     * @param {object} options - é…ç½®é€‰é¡¹
     * @param {string} options.title - æ ‡é¢˜
     * @param {string} options.content - å†…å®¹ï¼ˆå¯ä»¥æ˜¯ HTML å­—ç¬¦ä¸²ï¼‰
     * @param {Array<object>} [options.buttons=[]] - æŒ‰é’®é…ç½®
     * @param {string} [options.type='modal'] - å¯¹è¯æ¡†ç±»å‹ ('modal' æˆ– 'bottom-sheet')
     * @param {boolean} [options.scrollable=false] - å†…å®¹æ˜¯å¦å¯æ»šåŠ¨ (æ–°å¢)
     * @returns {{dialog: Element, close: function}} - è¿”å›å¯¹è¯æ¡†å…ƒç´ å’Œå…³é—­å‡½æ•°
     */
    function showDialog(options) {
        const { title, content, buttons = [], type = 'modal', scrollable = false } = options;
        const overlay = document.createElement('div');
        overlay.className = 'dialog-overlay';
        const dialog = document.createElement('div');
        let dialogClass = 'dialog';
        if (type === 'bottom-sheet') {
            dialogClass += ' dialog-bottom-sheet';
        }
        // ä¿®å¤ï¼šæ·»åŠ å¯æ»šåŠ¨ç±»
        if (scrollable) {
            dialogClass += ' dialog-scrollable';
        }
        dialog.className = dialogClass;
        
        let dialogHtml = `<div class="dialog-title">\( {title}</div><div class="dialog-content"> \){content}</div>`;
        if (buttons.length > 0) {
            dialogHtml += '<div class="dialog-actions">';
            buttons.forEach(btn => { 
                // ä¿®æ­£: ä¸ºæ‰“å¼€æŒ‰é’®è®¾ç½®ç‰¹å®šçš„æ ·å¼å’Œè¡Œä¸º
                let buttonClass = 'btn';
                let buttonStyle = '';
                if (btn.text === 'æ‰“å¼€' && btn.url) { // æ£€æŸ¥æ˜¯å¦æœ‰ URL å±æ€§
                    buttonClass += ' btn-raised'; // è®©å®ƒæ›´æ˜¾çœ¼
                    buttonStyle = 'style="flex: 1;"';
                    dialogHtml += `<a href="\( {btn.url}" target="_blank" class=" \){buttonClass}" \( {buttonStyle}><i class="material-icons">open_in_new</i> \){btn.text}</a>`;
                } else {
                    // ä¿®å¤ï¼šä¸ºæŒ‰é’®æ·»åŠ  data-id ä»¥ä¾¿äº‹ä»¶ç›‘å¬ï¼Œå¹¶ç¡®ä¿é URL æŒ‰é’®ä½¿ç”¨ <button> æ ‡ç­¾
                    // ä¿®å¤ï¼šç¡®ä¿æ‰€æœ‰æŒ‰é’®éƒ½æœ‰ data-idï¼Œç”¨äºäº‹ä»¶ç›‘å¬
                    dialogHtml += `<button class="\( {buttonClass}" data-id=" \){btn.text}" \( {buttonStyle}><i class="material-icons"> \){btn.icon || ''}</i>${btn.text}</button>`;
                }
            });
            dialogHtml += '</div>';
        }
        dialog.innerHTML = dialogHtml;
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);

        const closeDialog = () => {
            overlay.classList.remove('visible');
            // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿åœ¨ç§»é™¤å‰æ‰§è¡Œ CSS åŠ¨ç”»
            requestAnimationFrame(() => {
                overlay.addEventListener('transitionend', () => overlay.remove(), { once: true });
            });
        };

        overlay.addEventListener('click', (e) => { if (e.target === overlay) closeDialog(); });

        dialog.querySelectorAll('.btn').forEach(btnElement => {
            // ä»…å¤„ç† <button> æ ‡ç­¾ï¼Œ<a> æ ‡ç­¾ç”±æµè§ˆå™¨é»˜è®¤å¤„ç†
            if (btnElement.tagName === 'BUTTON') {
                const btnId = btnElement.dataset.id;
                const btnConfig = buttons.find(b => b.text === btnId);
                btnElement.addEventListener('click', () => {
                    if (btnConfig && btnConfig.onClick) btnConfig.onClick();
                    // ä»…åœ¨ onClick ä¸­æ²¡æœ‰é˜»æ­¢å…³é—­æ—¶æ‰§è¡Œå…³é—­
                    if (!btnConfig || !btnConfig.preventClose) {
                        closeDialog();
                    }
                });
            }
        });
        
        setTimeout(() => overlay.classList.add('visible'), 10);
        
        // è¿”å›å¯¹è¯æ¡†å…ƒç´ å’Œå…³é—­å‡½æ•°ï¼Œç”¨äºå¤–éƒ¨æ§åˆ¶
        return { dialog, close: closeDialog }; 
    }
    
    // --- åº”ç”¨é€»è¾‘ ---
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    const uploadArea = \( ('#uploadArea'), uploadTip = \)('#uploadTip'), imageUpload = $('#imageUpload');
    const apiSelector = \( ('#apiSelector'), selectedApiName = \)('#selectedApiName'), apiSelectorButton = $('#apiSelectorButton');
    const uploadButton = \( ('#uploadButton'), statusMessage = \)('#statusMessage'), imagePreview = $('#imagePreview');
    const progressContainer = \( ('#uploadProgressContainer'), progressBar = \)('#uploadProgressBar');
    const resultArea = \( ('#resultArea'), resultUrlDisplay = \)('#resultUrl'), openUrlButton = \( ('#openUrlButton'), copyUrlButton = \)('#copyUrlButton'), enhanceImageButton = \( ('#enhanceImageButton'), addWatermarkButton = \)('#addWatermarkButton'); 
    const yiyanContent = \( ('#yiyanContent'), yiyanFrom = \)('#yiyanFrom'), refreshYiyanButton = $('#refreshYiyanButton');
    const historyList = \( ('#historyList'), clearHistoryButton = \)('#clearHistoryButton'), toggleHistoryButton = $('#toggleHistoryButton');
    const themeToggleButton = $('#themeToggleButton');
    const fileSizeTip = $('#fileSizeTip');
    const urlFormatSelector = $('#urlFormatSelector');
    const censorStatusElement = \( ('#censorStatus'), visitorCountElement = \)('#visitorCount');
    const memorialBanner = $('#memorialBanner'); // æ–°å¢ï¼šæ‚¼å¿µæ¨ªå¹…å…ƒç´ 
    const memorialBannerText = $('#memorialBannerText'); // æ–°å¢ï¼šæ‚¼å¿µæ¨ªå¹…æ–‡æœ¬å…ƒç´ 
    const closeMemorialButton = $('#closeMemorialButton'); // æ–°å¢ï¼šå…³é—­æŒ‰é’®
    const historyViewToggle = $('#historyViewToggle');
    const fab = $('#fab');

    const CURRENT_APP_VERSION = 'v7.9'; // ç‰ˆæœ¬å·å‡çº§
    const VERSION_KEY = 'yunluo_app_version';
    const localStorageKey = 'yunluo_image_upload_history_v3'; 
    const API_PREFERENCE_KEY = 'yunluo_api_preference';
    const MAX_HISTORY_ITEMS = 15;
    const THEME_KEY = 'yunluo_theme_mode';
    const URL_FORMAT_KEY = 'yunluo_url_format';
    const HISTORY_COLLAPSED_KEY = 'yunluo_history_collapsed'; 
    const CENSOR_API_URL = 'https://api.pearktrue.cn/api/pornimage/';
    const VISITOR_COUNT_API = 'https://api.jkyai.top/API/tjfksl/tongji.php';
    const CENSOR_CLASSIFICATIONS_TO_BLOCK = ['è‰²æƒ…', 'éœ²ç‚¹', 'hentai', 'æš´åŠ›', 'æš´æ'];
    // ä¿®å¤ï¼šMEMORIAL_CLOSED_KEY ç°åœ¨å­˜å‚¨çš„æ˜¯å½“å‰çºªå¿µäººç‰© ID ç»„åˆçš„å“ˆå¸Œå€¼
    const MEMORIAL_CLOSED_KEY = 'yunluo_memorial_closed_hash'; 
    
    // æ–°å¢ï¼šæ°´å°ç›¸å…³å¸¸é‡
    const WATERMARK_API = 'https://api.jkyai.top/API/tpsytj';
    const DEFAULT_WATERMARK_TEXT = 'äº‘è½å›¾åºŠ https://jiayuxuan123.rth2.xyz/';
    const WATERMARK_DOA = 3; // å³ä¸‹è§’
    const WATERMARK_SIZE = 20; // å­—ä½“å¤§å°
    const UPLOADS_TODAY_KEY_PREFIX = 'yunluo_uploads_today_';
    const MAX_UPLOADS_PER_DAY = 15;
    
    // æ–°å¢ AI å¢å¼º API ä¿¡æ¯
    const AI_ENHANCE_API = {
        url: 'http://api-v2.yuafeng.cn/API/clear_image.php',
        key: 'fd950751ea8a7465b66267db0e31874f96bf61ac0bd421b853d148088bd96838'
    };

    const API_OPTIONS = [ 
        { value: 'yanxuan', name: 'ç½‘æ˜“ä¸¥é€‰å›¾åºŠ', tip: 'æ”¯æŒå›¾ç‰‡ï¼Œå•æ–‡ä»¶é™åˆ¶ 5MBã€‚', isRecommended: true, endpoint: 'https://api.xinyew.cn/api/yanxuantc', fileSize: 5*1024*1024, fileName: 'file', accept: 'image/*' }, 
        { value: 'main', name: 'ä¸»æ¥å£ (360å›¾åºŠ)', tip: 'æ”¯æŒå›¾ç‰‡ï¼Œå•æ–‡ä»¶é™åˆ¶ 5MBã€‚', isRecommended: false, endpoint: 'https://api.xinyew.cn/api/360tc', fileSize: 5*1024*1024, fileName: 'file', accept: 'image/*' }, 
        { value: 'backup', name: 'å¤‡ç”¨æ¥å£ (äº¬ä¸œå›¾åºŠ)', tip: 'æ”¯æŒå›¾ç‰‡ï¼Œå•æ–‡ä»¶é™åˆ¶ 5MBã€‚', isRecommended: false, endpoint: 'https://api.xinyew.cn/api/jdtc', fileSize: 5*1024*1024, fileName: 'file', accept: 'image/*' }, 
        { value: 'sogou', name: 'æœç‹—å›¾åºŠ (éœ€metaå¤´)', tip: 'æ”¯æŒå›¾ç‰‡ï¼Œå•æ–‡ä»¶é™åˆ¶ 5MBã€‚', isRecommended: false, endpoint: 'https://api.xinyew.cn/api/sogotc', fileSize: 5*1024*1024, fileName: 'file', accept: 'image/*' } 
    ];
    let selectedFile = null, sogouMetaTag = null, uploadedUrl = '', currentUrlFormat = localStorage.getItem(URL_FORMAT_KEY) || 'url';
    const API_CONFIG = API_OPTIONS.reduce((acc, curr) => { acc[curr.value] = curr; return acc; }, {});

    let todayMemorialFigures = []; // æ–°å¢ï¼šä¿å­˜ä»Šæ—¥æ‰€æœ‰çºªå¿µäººç‰©çš„åˆ—è¡¨
    let todayUploadCount = 0; // æ–°å¢ï¼šä»Šæ—¥ä¸Šä¼ è®¡æ•°

    const truncateFilename = (name, maxLength) => name.length > maxLength ? `\( {name.slice(0, maxLength / 2)}... \){name.slice(-maxLength / 2)}` : name;
    async function copyToClipboard(text, successMessage) { try { await navigator.clipboard.writeText(text); showSnackbar(successMessage); } catch (err) { showSnackbar('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ“ä½œ'); } }
    
    function getTodayKey() {
        return UPLOADS_TODAY_KEY_PREFIX + new Date().toDateString();
    }
    
    function getTodayUploadCount() {
        const key = getTodayKey();
        return parseInt(localStorage.getItem(key) || '0', 10);
    }
    
    function incrementTodayUploadCount() {
        const key = getTodayKey();
        todayUploadCount = getTodayUploadCount() + 1;
        localStorage.setItem(key, todayUploadCount.toString());
        updateWatermarkUI(); // æ›´æ–°UIçŠ¶æ€
        return todayUploadCount;
    }
    
    function updateWatermarkUI() {
        const isOverLimit = todayUploadCount >= MAX_UPLOADS_PER_DAY;
        addWatermarkButton.disabled = isOverLimit;
        addWatermarkButton.title = isOverLimit ? 'ä»Šæ—¥ä¸Šä¼ å·²è¾¾ä¸Šé™ï¼Œæ°´å°è‡ªåŠ¨æ·»åŠ ' : 'è‡ªå®šä¹‰æ·»åŠ æ°´å°';
        if (isOverLimit) {
            addWatermarkButton.innerHTML = '<i class="material-icons">lock</i>æ°´å°è‡ªåŠ¨';
        } else {
            addWatermarkButton.innerHTML = '<i class="material-icons">branding_watermark</i>æ·»åŠ æ°´å°';
        }
    }
    
    async function addWatermark(originalUrl, originalFileName, customText = null, isAuto = false) {
        const text = customText || DEFAULT_WATERMARK_TEXT;
        const loadingDialog = showDialog({
            title: isAuto ? 'è‡ªåŠ¨æ·»åŠ æ°´å°' : 'æ·»åŠ æ°´å°ä¸­',
            content: `<p style="text-align:center;"><i class="material-icons" style="vertical-align: middle;">autorenew</i> æ­£åœ¨å¤„ç†æ°´å°ï¼Œè¯·ç¨å€™...</p>`,
            buttons: []
        });
        
        try {
            // 1. è°ƒç”¨æ°´å°APIè·å–æ°´å°åçš„å›¾ç‰‡blob
            const watermarkUrl = `\( {WATERMARK_API}?url= \){encodeURIComponent(originalUrl)}&text=\( {encodeURIComponent(text)}&doa= \){WATERMARK_DOA}&size=${WATERMARK_SIZE}`;
            const watermarkResponse = await fetch(watermarkUrl);
            if (!watermarkResponse.ok) {
                throw new Error(`æ°´å°APIé”™è¯¯: ${watermarkResponse.status}`);
            }
            const watermarkBlob = await watermarkResponse.blob();
            
            // 2. å°†æ°´å°blobä½œä¸ºæ–°æ–‡ä»¶ä¸Šä¼ åˆ°å½“å‰å›¾åºŠAPI
            const config = API_CONFIG[apiSelector.value];
            const formData = new FormData();
            const watermarkedFileName = originalFileName.replace(/\.[^/.]+$/, '') + (isAuto ? '_auto_watermarked.jpg' : '_watermarked.jpg');
            formData.append(config.fileName, watermarkBlob, watermarkedFileName);
            
            const xhr = new XMLHttpRequest();
            xhr.open('POST', config.endpoint, true);
            
            return new Promise((resolve, reject) => {
                xhr.onload = () => {
                    loadingDialog.close();
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            if ((data.code === 200 && data.url) || (data.errno === 0 && data.data?.url)) {
                                const newUrl = data.url || data.data.url;
                                const message = isAuto ? 'æ°´å°å·²è‡ªåŠ¨æ·»åŠ ' : 'æ°´å°æ·»åŠ æˆåŠŸ';
                                showSnackbar(message);
                                resolve({ url: newUrl, name: watermarkedFileName });
                            } else {
                                reject(new Error(data.msg || data.error || data.message || 'å›¾åºŠAPIè¿”å›æ ¼å¼é”™è¯¯'));
                            }
                        } catch (e) {
                            reject(new Error('è§£æå“åº”å¤±è´¥'));
                        }
                    } else {
                        reject(new Error(`HTTP ${xhr.status} é”™è¯¯`));
                    }
                };
                
                xhr.onerror = () => {
                    loadingDialog.close();
                    reject(new Error('ç½‘ç»œè¿æ¥é”™è¯¯'));
                };
                
                xhr.send(formData);
            });
        } catch (error) {
            loadingDialog.close();
            const title = isAuto ? 'è‡ªåŠ¨æ°´å°å¤±è´¥' : 'æ·»åŠ æ°´å°å¤±è´¥';
            showDialog({
                title: `${title} ğŸ˜¢`,
                content: `<p>å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š${error.message}ã€‚åŸå›¾é“¾æ¥ä¿æŒä¸å˜ã€‚</p>`,
                buttons: [{ text: 'å¥½çš„' }]
            });
            return null;
        }
    }
    
    // æ–°å¢ï¼šè‡ªå®šä¹‰æ°´å°å¯¹è¯æ¡†
    function showCustomWatermarkDialog(url, name) {
        const inputText = prompt('è¯·è¾“å…¥æ°´å°æ–‡æœ¬ï¼ˆé»˜è®¤ï¼š' + DEFAULT_WATERMARK_TEXT + 'ï¼‰ï¼š', DEFAULT_WATERMARK_TEXT);
        if (inputText === null) {
            return; // ç”¨æˆ·å–æ¶ˆ
        }
        const text = inputText.trim() || DEFAULT_WATERMARK_TEXT; // å¦‚æœä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤
        addWatermark(url, name, text).then(result => {
            if (result) {
                // ä¿®å¤ï¼šåˆ é™¤åŸæ¥çš„æ— æ°´å°å†å²è®°å½•ï¼ˆç¡®ä¿urlæ˜¯æ—§çš„åŸå§‹urlï¼‰
                deleteHistoryItem(url); // url æ˜¯æ— æ°´å°çš„åŸå§‹URL
                // æ›´æ–°å½“å‰ä¸Šä¼ ç»“æœä¸ºæ–°çš„æœ‰æ°´å°é¡¹
                uploadedUrl = result.url;
                selectedFile.name = result.name;
                resultUrlDisplay.textContent = getFormattedUrl(uploadedUrl, selectedFile.name, currentUrlFormat);
                updateResultAreaButtons(uploadedUrl, selectedFile);
                // æ·»åŠ æ–°çš„æœ‰æ°´å°é¡¹åˆ°å†å²
                addHistoryItem(result.name, result.url);
                // å¼ºåˆ¶åˆ·æ–°å†å²åˆ—è¡¨ä»¥ç¡®ä¿ç«‹å³æ˜¾ç¤ºï¼Œå¹¶é˜²æ­¢ä»»ä½•ç¼“å­˜é—®é¢˜
                loadHistory();
                // æ–°å¢ï¼šæ˜¾ç¤ºç¡®è®¤æç¤ºï¼Œè¯æ˜åˆ çš„æ˜¯æ— æ°´å°çš„
                showSnackbar('æ— æ°´å°è®°å½•å·²åˆ é™¤ï¼Œæœ‰æ°´å°çš„æ–°è®°å½•å·²æ·»åŠ ');
            }
        });
    }

    function updateApiSelectionUI() { 
        const config = API_CONFIG[apiSelector.value]; 
        selectedApiName.textContent = config.name; 
        fileSizeTip.textContent = config.tip; 
        imageUpload.setAttribute('accept', config.accept); 
        if (selectedFile) handleFileSelect(selectedFile); 
        
        // ä¿®å¤ï¼šæ›´æ–° Open URL æŒ‰é’®çš„çŠ¶æ€
        updateResultAreaButtons(uploadedUrl, selectedFile);
    }
    function showApiSelectorDialog() { let listHtml = '<ul class="list">'; API_OPTIONS.forEach(opt => { const isChecked = opt.value === apiSelector.value; const badge = opt.isRecommended ? '<span class="recommended-badge">æ¨è</span>' : ''; listHtml += `<li class="list-item" data-value="\( {opt.value}"><div class="list-item-content"> \){opt.name} \( {badge}</div><div class="list-item-icon"><i class="material-icons">radio_button_ \){isChecked ? 'checked' : 'unchecked'}</i></div></li>`; }); listHtml += '</ul>'; const { dialog } = showDialog({ title: 'é€‰æ‹©æ¥å£', content: listHtml, type: 'bottom-sheet' }); dialog.querySelectorAll('.list-item').forEach(item => { item.addEventListener('click', function() { const newVal = this.dataset.value; dialog.querySelectorAll('.material-icons').forEach(i => i.textContent = 'radio_button_unchecked'); this.querySelector('.material-icons').textContent = 'radio_button_checked'; setTimeout(() => { if (newVal !== apiSelector.value) { apiSelector.value = newVal; localStorage.setItem(API_PREFERENCE_KEY, newVal); selectedFile = null; imageUpload.value = ''; imagePreview.style.display = 'none'; uploadButton.disabled = true; statusMessage.textContent = 'è¯·é€‰æ‹©æ–°æ–‡ä»¶'; censorStatusElement.style.display = 'none'; updateApiSelectionUI(); } dialog.closest('.dialog-overlay')?.click(); }, 200); }); }); }
    const getFormattedUrl = (url, fileName, format) => { const name = fileName.replace(/\.[^/.]+\( /, ""); switch (format) { case 'markdown': return `![ \){name}](\( {url})`; case 'html': return `<img src=" \){url}" alt="\( {name}" title=" \){name}">`; default: return url; } };
    function updateResultAreaButtons(url, file) {
        const isImage = file && file.type.startsWith('image/');
        // ä¿®å¤ï¼šOpen æŒ‰é’®
        if (url) {
            openUrlButton.style.display = 'inline-flex';
            openUrlButton.onclick = () => window.open(url, '_blank');
        } else {
            openUrlButton.style.display = 'none';
            openUrlButton.onclick = null;
        }
        // AI å¢å¼ºæŒ‰é’®
        enhanceImageButton.style.display = isImage ? 'inline-flex' : 'none';
        // æ°´å°æŒ‰é’®
        if (isImage) {
            addWatermarkButton.style.display = 'inline-flex';
            const isOverLimit = getTodayUploadCount() >= MAX_UPLOADS_PER_DAY;
            addWatermarkButton.disabled = isOverLimit || url.includes('_watermarked');
            addWatermarkButton.title = isOverLimit ? 'ä»Šæ—¥ä¸Šä¼ å·²è¾¾ä¸Šé™ï¼Œæ°´å°è‡ªåŠ¨æ·»åŠ ' : (url.includes('_watermarked') ? 'æ°´å°å·²æ·»åŠ ' : 'è‡ªå®šä¹‰æ·»åŠ æ°´å°');
            if (isOverLimit || url.includes('_watermarked')) {
                addWatermarkButton.innerHTML = '<i class="material-icons">check</i>æ°´å°å·²æ·»åŠ ';
            } else {
                addWatermarkButton.innerHTML = '<i class="material-icons">branding_watermark</i>æ·»åŠ æ°´å°';
            }
        } else {
            addWatermarkButton.style.display = 'none';
        }
    }
    function handleFormatChange(newFormat) { 
        currentUrlFormat = newFormat; 
        localStorage.setItem(URL_FORMAT_KEY, newFormat); 
        urlFormatSelector.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); 
        urlFormatSelector.querySelector(`[data-format="${newFormat}"]`).classList.add('active'); 
        if (uploadedUrl && selectedFile) { 
            resultUrlDisplay.textContent = getFormattedUrl(uploadedUrl, selectedFile.name, newFormat); 
            // ä¿®å¤ï¼šå¦‚æœåˆ‡æ¢æ ¼å¼ï¼ŒOpen æŒ‰é’®ä¸å—å½±å“ï¼Œä½†ç¡®ä¿å…¶çŠ¶æ€æ­£ç¡®
            updateResultAreaButtons(uploadedUrl, selectedFile);
        } 
    }
    function handleFileSelect(file) { 
        if (!file) { 
            selectedFile = null; 
            uploadButton.disabled = true; 
            imagePreview.style.display = 'none'; 
            uploadTip.textContent = 'æ‹–æ‹½æ–‡ï¿½ï¿½ï¿½åˆ°è¿™é‡Œæˆ–'; 
            return; 
        } 
        const config = API_CONFIG[apiSelector.value]; 
        const reset = () => { 
            statusMessage.textContent = ''; 
            selectedFile = null; 
            uploadButton.disabled = true; 
            imagePreview.style.display = 'none'; 
            fileSizeTip.textContent = config.tip; 
            censorStatusElement.style.display = 'none'; 
            updateResultAreaButtons('', null); // ä¿®å¤
        }; 
        if (config.accept !== '*' && !file.type.startsWith('image/')) { 
            reset(); 
            statusMessage.textContent = 'è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼'; 
            statusMessage.className = 'status-error'; 
            uploadTip.textContent = 'æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–'; 
            return; 
        } 
        if (file.size > config.fileSize) { 
            reset(); 
            statusMessage.textContent = `æ–‡ä»¶è¶…è¿‡ ${(config.fileSize / (1024*1024)).toFixed(2)}MBï¼`; 
            statusMessage.className = 'status-error'; 
            uploadTip.textContent = 'æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–'; 
            return; 
        } 
        selectedFile = file; 
        statusMessage.textContent = ''; 
        fileSizeTip.textContent = `å·²é€‰æ‹©: \( {selectedFile.name} ( \){(selectedFile.size / (1024 * 1024)).toFixed(2)} MB)`; 
        uploadButton.disabled = false; 
        if (file.type.startsWith('image/')) { 
            const reader = new FileReader(); 
            reader.onload = e => { 
                imagePreview.src = e.target.result; 
                imagePreview.style.display = 'block'; 
            }; 
            reader.readAsDataURL(selectedFile); 
            setCensorStatus('normal', 'å›¾ç‰‡å·²é€‰ä¸­ã€‚ä¸Šä¼ åå°†è¿›è¡Œæœ€ç»ˆå®‰å…¨æ£€æŸ¥ã€‚', true); 
        } else { 
            imagePreview.style.display = 'none'; 
            setCensorStatus('normal', 'éå›¾ç‰‡æ–‡ä»¶ï¼Œå®‰å…¨æ£€æŸ¥å°†è·³è¿‡ã€‚', true); 
        } 
        resultArea.style.display = 'none'; 
        uploadTip.textContent = `æ–‡ä»¶å·²å°±ç»ª: ${truncateFilename(selectedFile.name, 28)}`; 
        updateResultAreaButtons('', selectedFile); // ä¿®å¤
    }
    
    // æ ¸å¿ƒï¼šAI å¢å¼ºåŠŸèƒ½
    async function enhanceImage(url, originalName) {
        // 1. æ˜¾ç¤ºåŠ è½½å¯¹è¯æ¡†å¹¶è·å–å…³é—­å¥æŸ„
        const loadingDialog = showDialog({
            title: 'AI å›¾ç‰‡å¢å¼º',
            content: `<p style="text-align:center;"><i class="material-icons" style="vertical-align: middle;">autorenew</i> æ­£åœ¨è¯·æ±‚ AI æœåŠ¡å™¨ï¼Œè¯·ç¨å€™...</p>`,
            buttons: []
        });
        
        const enhanceUrl = `\( {AI_ENHANCE_API.url}?url= \){encodeURIComponent(url)}&apikey=${AI_ENHANCE_API.key}`;
        
        try {
            const response = await fetch(enhanceUrl);
            if (!response.ok) throw new Error(`HTTP é”™è¯¯: ${response.status}`);
            const data = await response.json();

            // 2. æˆåŠŸåï¼Œå…ˆå…³é—­åŠ è½½å¯¹è¯æ¡†
            loadingDialog.close();

            if (data.code === 0 && data.data && data.data.image) {
                const enhancedUrl = data.data.image;
                const enhancedName = `AIå¢å¼º-${originalName}`;
                
                addHistoryItem(enhancedName, enhancedUrl);
                
                // 3. æ˜¾ç¤ºæˆåŠŸå¯¹è¯æ¡†
                showDialog({
                    title: 'AI å¢å¼ºæˆåŠŸ ğŸ‰',
                    content: `<p>å›¾ç‰‡å·²æˆåŠŸå¢å¼ºï¼Œå¹¶å·²åŠ å…¥å†å²è®°å½•ã€‚</p><img src="${enhancedUrl}" alt="å¢å¼ºåçš„å›¾ç‰‡" style="max-width: 100%; border-radius: 12px; margin-top: 15px;">`,
                    buttons: [
                        { text: 'å…³é—­' },
                        // ä¿®å¤ï¼šæ–°å¢ Open æŒ‰é’®åˆ°å¯¹è¯æ¡†ï¼Œç¡®ä¿æœ‰ URL å±æ€§
                        { text: 'æ‰“å¼€', url: enhancedUrl },
                        { text: 'å¤åˆ¶é“¾æ¥', onClick: () => copyToClipboard(enhancedUrl, 'å¢å¼ºå›¾ç‰‡é“¾æ¥å·²å¤åˆ¶') }
                    ],
                    scrollable: true
                });
            } else {
                throw new Error(data.msg || 'APIè¿”å›æ ¼å¼é”™è¯¯');
            }
        } catch (error) {
            console.error('AI Enhance Error:', error);
            
            // 4. å¤±è´¥æ—¶ï¼Œå…³é—­åŠ è½½å¯¹è¯æ¡†
            loadingDialog.close();

            // 5. æ˜¾ç¤ºå¤±è´¥å¯¹è¯æ¡†
            showDialog({
                title: 'AI å¢å¼ºå¤±è´¥ ğŸ˜¢',
                content: `<p>å¤„ç†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š${error.message}ã€‚è¯·æ£€æŸ¥åŸå›¾é“¾æ¥æ˜¯å¦æœ‰æ•ˆï¼Œæˆ–ç¨åå†è¯•ã€‚</p>`,
                buttons: [{ text: 'å¥½çš„' }]
            });
        }
    }
    // æ ¸å¿ƒï¼šAI å¢å¼ºåŠŸèƒ½ END

    // æ–°å¢ï¼šæ‰‹åŠ¨æ·»åŠ æ°´å°äº‹ä»¶
    function handleAddWatermark() {
        if (getTodayUploadCount() >= MAX_UPLOADS_PER_DAY) {
            showSnackbar('ä»Šæ—¥ä¸Šä¼ å·²è¾¾ä¸Šé™ï¼Œæ°´å°å·²è‡ªåŠ¨æ·»åŠ ');
            return;
        }
        if (!uploadedUrl || !selectedFile || !selectedFile.type.startsWith('image/')) {
            showSnackbar('ä»…æ”¯æŒå›¾ç‰‡æ–‡ä»¶æ·»åŠ æ°´å°');
            return;
        }
        if (uploadedUrl.includes('_watermarked')) {
            showSnackbar('æ°´å°å·²æ·»åŠ ');
            return;
        }
        showCustomWatermarkDialog(uploadedUrl, selectedFile.name);
    }

    function renderHistory(history) { 
        historyList.innerHTML = ''; 
        const hasHistory = history.length > 0; 
        clearHistoryButton.style.display = hasHistory ? 'inline-flex' : 'none'; 
        toggleHistoryButton.style.display = hasHistory ? 'block' : 'none'; 
        historyViewToggle.style.display = hasHistory ? 'block' : 'none';
        $('#clearHistoryContainer').style.display = hasHistory ? 'block' : 'none'; 
        if (!hasHistory) { 
            historyList.innerHTML = `
                <li id="historyEmptyTip" style="text-align: center;">
                    <svg width="100" height="100" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" fill="var(--md-sys-color-primary-container)" />
                        <text x="50" y="55" text-anchor="middle" font-size="20">â˜ï¸</text>
                    </svg>
                    <p>è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»ä¸Šä¼ ç¬¬ä¸€å¼ å›¾ç‰‡å§~</p>
                </li>
            `; 
            return; 
        } 
        history.forEach(item => { 
            const li = document.createElement('li'); 
            li.className = 'history-item'; 
            li.dataset.url = item.url;
            li.dataset.name = item.name;
            const isImage = item.name.match(/\.(jpe?g|png|gif|bmp|webp|ico|svg|jpeg)$/i);
            
            // ä¿®æ­£ï¼šAI å¢å¼ºæŒ‰é’®ç°åœ¨å¯¹æ‰€æœ‰å›¾ç‰‡æ–‡ä»¶æ˜¾ç¤º
            const canEnhance = isImage;
            const canWatermark = isImage && !item.name.includes('_watermarked') && getTodayUploadCount() < MAX_UPLOADS_PER_DAY;
            
            li.innerHTML = `
                \( {isImage ? `<img src=" \){item.url}" alt="thumbnail" class="history-item-thumb" loading="lazy">` : `<div class="history-item-thumb"><i class="material-icons">insert_drive_file</i></div>`}
                <div class="history-item-info" data-url="\( {item.url}" data-name=" \){item.name}"><span>${truncateFilename(item.name, 35)}</span></div>
                <div class="history-item-actions">
                    <button class="open-button btn btn-icon" data-url="\( {item.url}" title="æ‰“å¼€é“¾æ¥" style="display: \){isImage ? 'block' : 'none'};"><i class="material-icons">open_in_new</i></button>
                    \( {canEnhance ? `<button class="enhance-button btn btn-icon" data-url=" \){item.url}" data-name="${item.name}" title="AI å›¾ç‰‡å¢å¼º"><i class="material-icons">auto_fix_high</i></button>` : ''}
                    \( {canWatermark ? `<button class="watermark-button btn btn-icon" data-url=" \){item.url}" data-name="${item.name}" title="è‡ªå®šä¹‰æ°´å°"><i class="material-icons">branding_watermark</i></button>` : ''}
                    <button class="delete-button btn btn-icon" data-url="\( {item.url}" data-name=" \){item.name}"><i class="material-icons">delete</i></button>
                </div>
                <button class="swipe-delete">åˆ é™¤</button>
            `; 
            historyList.appendChild(li); 
        }); 
    }
    function loadHistory() { const history = JSON.parse(localStorage.getItem(localStorageKey)) || []; renderHistory(history); applyHistoryCollapseState(history.length > 0); }
    function addHistoryItem(name, url) { let history = JSON.parse(localStorage.getItem(localStorageKey)) || []; history = history.filter(item => item.url !== url); history.unshift({ name, url, timestamp: Date.now() }); if (history.length > MAX_HISTORY_ITEMS) history.pop(); localStorage.setItem(localStorageKey, JSON.stringify(history)); renderHistory(history); }
    function deleteHistoryItem(url) { let history = JSON.parse(localStorage.getItem(localStorageKey)) || []; history = history.filter(item => item.url !== url); localStorage.setItem(localStorageKey, JSON.stringify(history)); renderHistory(history); showSnackbar('è¯¥æ¡å†å²è®°å½•å·²åˆ é™¤'); if (history.length === 0) setHistoryCollapseState(true); }
    function clearAllHistory() { showDialog({ title: 'ç¡®è®¤æ¸…ç©º', content: 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä¸Šä¼ å†å²è®°å½•å—ï¼Ÿ', buttons: [{ text: 'å–æ¶ˆ' }, { text: 'ç¡®å®š', onClick: () => { localStorage.removeItem(localStorageKey); renderHistory([]); showSnackbar('æ‰€æœ‰å†å²è®°å½•å·²æ¸…ç©º'); setHistoryCollapseState(true); }}] }); }
    
    // --- ä¿®å¤åçš„å†å²è®°å½•æŠ˜å /å±•å¼€é€»è¾‘ ---
    function setHistoryCollapseState(isCollapsed) {
        localStorage.setItem(HISTORY_COLLAPSED_KEY, isCollapsed ? 'true' : 'false');
        
        // ç¡®ä¿ DOM å…ƒç´ å­˜åœ¨ï¼Œå¹¶ä¸”æœ‰å†å²è®°å½•æ—¶æ‰æ˜¾ç¤ºæ¸…ç©ºæŒ‰é’®
        const hasHistory = (JSON.parse(localStorage.getItem(localStorageKey)) || []).length > 0;
        
        if (isCollapsed) {
            historyList.classList.remove('visible');
            historyList.classList.add('hidden');
            toggleHistoryButton.querySelector('.material-icons').textContent = 'keyboard_arrow_down';
            $('#clearHistoryContainer').style.display = 'none'; // æŠ˜å æ—¶éšè—æ¸…ç©ºæŒ‰é’®
        } else {
            historyList.classList.remove('hidden');
            historyList.classList.add('visible'); // ä¿®å¤ï¼šç¡®ä¿å±•å¼€æ—¶æœ‰ visible ç±»
            toggleHistoryButton.querySelector('.material-icons').textContent = 'keyboard_arrow_up';
            if (hasHistory) {
                $('#clearHistoryContainer').style.display = 'block'; // å±•å¼€ä¸”æœ‰å†å²æ—¶æ˜¾ç¤ºæ¸…ç©ºæŒ‰é’®
            }
        }
    }
    
    function applyHistoryCollapseState(hasHistory) {
        const saved = localStorage.getItem(HISTORY_COLLAPSED_KEY);
        // å¦‚æœæ²¡æœ‰å†å²è®°å½•ï¼Œå¼ºåˆ¶æŠ˜å ï¼ˆéšè—ï¼‰
        const shouldCollapse = !hasHistory || (saved === 'true');
        setHistoryCollapseState(shouldCollapse);
    }
    // --- ä¿®å¤åçš„å†å²è®°å½•æŠ˜å /å±•å¼€é€»è¾‘ END ---

    function setCensorStatus(level, message, show = true) { censorStatusElement.style.display = show ? 'block' : 'none'; censorStatusElement.className = `censor-${level}`; censorStatusElement.querySelector('span').textContent = message; censorStatusElement.querySelector('.material-icons').textContent = level === 'safe' ? 'check_circle' : level === 'warning' ? 'error' : 'security'; }
    async function checkCensor(url) { if (!selectedFile.type.startsWith('image/')) { setCensorStatus('normal', 'éå›¾ç‰‡æ–‡ä»¶ï¼Œå®‰å…¨æ£€æŸ¥è·³è¿‡ã€‚', true); return true; } setCensorStatus('normal', 'æ­£åœ¨è¿›è¡Œå®‰å…¨æ£€æŸ¥...', true); try { const response = await fetch(CENSOR_API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ file: url }) }); if (!response.ok) { setCensorStatus('normal', `å®‰å…¨æ£€æŸ¥æœåŠ¡é”™è¯¯(\( {response.status})ï¼Œé“¾æ¥å·²æ”¾è¡Œã€‚`, true); return true; } const result = await response.json(); if (result.code !== 200 || !result.data) { setCensorStatus('normal', `å®‰å…¨æ£€æŸ¥å¤±è´¥( \){result.msg || 'æœªçŸ¥é”™è¯¯'})ï¼Œé“¾æ¥å·²æ”¾è¡Œã€‚`, true); return true; } const classification = result.classification || 'æœªçŸ¥'; if (CENSOR_CLASSIFICATIONS_TO_BLOCK.includes(classification)) { const message = `å®‰å…¨è­¦å‘Šï¼å›¾ç‰‡è¢«åˆ¤å®šä¸ºï¼š\( {classification}ã€‚é“¾æ¥å·²æ‹¦æˆªã€‚`; setCensorStatus('warning', message, true); return false; } else { const message = `å®‰å…¨æ£€æŸ¥é€šè¿‡ã€‚å›¾ç‰‡åˆ†ç±»ï¼š \){classification}ã€‚`; setCensorStatus('safe', message, true); return true; } } catch (error) { console.error('Censor API error:', error); setCensorStatus('normal', 'å®‰å…¨æ£€æŸ¥ç½‘ç»œé”™è¯¯ï¼Œé“¾æ¥å·²æ”¾è¡Œã€‚', true); return true; } }
    
    async function uploadFile() { 
        if (!selectedFile) return; 
        
        const config = API_CONFIG[apiSelector.value]; 
        
        if (config.accept === 'image/*' && !selectedFile.type.startsWith('image/')) { 
            statusMessage.textContent = 'å½“å‰æ¥å£ä»…æ”¯æŒä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼'; 
            statusMessage.className = 'status-error'; 
            return; 
        } 
        
        statusMessage.textContent = 'å‡†å¤‡ä¸Šä¼ ...'; 
        statusMessage.className = ''; 
        uploadButton.disabled = true; 
        resultArea.style.display = 'none'; 
        progressContainer.style.display = 'block'; 
        progressBar.style.width = '0%'; 
        setCensorStatus('normal', 'æ–‡ä»¶ä¸Šä¼ ä¸­...', true); 
        
        // Integrate progress into button
        const originalButtonHTML = uploadButton.innerHTML;
        uploadButton.innerHTML = '<div class="progress-bar" id="buttonProgress" style="width: 0%; height: 100%; position: absolute; left: 0; top: 0; background-color: rgba(255,255,255,0.3);"></div><span style="z-index: 1;">ä¸Šä¼ ä¸­...</span>';
        
        const onSuccess = async (url, fileName) => { 
            let finalUrl = url;
            let finalFileName = fileName;
            const isImage = selectedFile.type.startsWith('image/');
            const currentCount = getTodayUploadCount();
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨æ·»åŠ æ°´å°ï¼ˆè¶…è¿‡15æ¬¡ä¸”æ˜¯å›¾ç‰‡ï¼‰
            if (isImage && currentCount >= MAX_UPLOADS_PER_DAY) {
                const watermarkResult = await addWatermark(url, fileName, null, true);
                if (watermarkResult) {
                    finalUrl = watermarkResult.url;
                    finalFileName = watermarkResult.name;
                    // æ–°å¢ï¼šé˜²æŠ¤ï¼Œå¦‚æœåŸå§‹urlå·²åœ¨å†å²ä¸­ï¼ˆè™½æ­£å¸¸ä¸ä¼šï¼Œä½†é˜²ä¸‡ä¸€ï¼‰ï¼Œåˆ é™¤å®ƒ
                    
                }
            }
            
            // é€’å¢è®¡æ•°ï¼ˆæ— è®ºæ˜¯å¦æ·»åŠ æ°´å°ï¼‰
            incrementTodayUploadCount();
            
            if (isImage) { 
                const isSafe = await checkCensor(finalUrl); 
                if (!isSafe) { 
                    statusMessage.textContent = 'ä¸Šä¼ æˆåŠŸï¼Œä½†å›¾ç‰‡å®‰å…¨æ£€æŸ¥æœªé€šè¿‡ï¼Œé“¾æ¥å·²æ‹¦æˆªã€‚'; 
                    statusMessage.className = 'status-error'; 
                    uploadedUrl = ''; 
                    resultArea.style.display = 'none'; 
                    updateResultAreaButtons('', selectedFile); // ä¿®å¤
                    return; 
                } 
            } else { 
                setCensorStatus('normal', 'éå›¾ç‰‡æ–‡ä»¶ï¼Œå®‰å…¨æ£€æŸ¥è·³è¿‡ã€‚', true); 
            } 
            uploadedUrl = finalUrl; 
            selectedFile.name = finalFileName; // æ›´æ–° selectedFile.name ä»¥ç¡®ä¿ä¸€è‡´
            statusMessage.textContent = 'ä¸Šä¼ æˆåŠŸï¼'; 
            statusMessage.className = 'status-success'; 
            resultUrlDisplay.textContent = getFormattedUrl(finalUrl, finalFileName, currentUrlFormat); 
            resultArea.style.display = 'block'; 
            updateResultAreaButtons(finalUrl, selectedFile); 
            addHistoryItem(finalFileName, finalUrl); 
            // å¼ºåˆ¶åˆ·æ–°å†å²åˆ—è¡¨
            loadHistory();
            // Confetti celebration
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }; 
        
        const onError = (msg) => { 
            uploadedUrl = ''; 
            statusMessage.textContent = `ä¸Šä¼ å¤±è´¥: ${msg}`; 
            statusMessage.className = 'status-error'; 
            setCensorStatus('warning', 'ä¸Šä¼ å¤±è´¥ï¼Œæœªè¿›è¡Œå®‰å…¨æ£€æŸ¥ã€‚', true); 
            updateResultAreaButtons('', selectedFile); // ä¿®å¤
        }; 
        
        try { 
            const formData = new FormData(); 
            formData.append(config.fileName, selectedFile, selectedFile.name); 
            const xhr = new XMLHttpRequest(); 
            xhr.open('POST', config.endpoint, true); 
            
            xhr.upload.onprogress = e => { 
                if (e.lengthComputable) { 
                    const percent = (e.loaded / e.total) * 100; 
                    progressBar.style.width = percent + '%'; 
                    $('#buttonProgress').style.width = percent + '%';
                    statusMessage.textContent = `ä¸Šä¼ ä¸­... ${Math.round(percent)}%`; 
                } 
            }; 
            
            xhr.onloadend = () => { 
                uploadButton.disabled = false; 
                progressContainer.style.display = 'none'; 
                uploadButton.innerHTML = originalButtonHTML;
            }; 
            
            xhr.onerror = () => { 
                onError('ç½‘ç»œè¿æ¥é”™è¯¯'); 
                sogouMetaTag?.remove(); 
                sogouMetaTag = null; 
            }; 
            
            xhr.onload = () => { 
                sogouMetaTag?.remove(); 
                sogouMetaTag = null; 
                if (xhr.status >= 200 && xhr.status < 300) { 
                    try { 
                        const data = JSON.parse(xhr.responseText); 
                        if ((data.code === 200 && data.url) || (data.errno === 0 && data.data?.url)) { 
                            const url = data.url || data.data.url; 
                            onSuccess(url, selectedFile.name); 
                            if (apiSelector.value === 'sogou' && data.meta) { 
                                const temp = document.createElement('div'); 
                                temp.innerHTML = data.meta; 
                                sogouMetaTag = temp.firstChild; 
                                document.head.appendChild(sogouMetaTag); 
                            } 
                        } else { 
                            onError(data.msg || data.error || data.message || 'APIè¿”å›æ ¼å¼é”™è¯¯'); 
                        } 
                    } catch (e) { 
                        onError('è§£æå“åº”å¤±è´¥'); 
                    } 
                } else { 
                    onError(`HTTP ${xhr.status} é”™è¯¯`); 
                } 
            }; 
            xhr.send(formData); 
        } catch (error) { 
            onError(error.message); 
            uploadButton.disabled = false; 
            progressContainer.style.display = 'none'; 
            uploadButton.innerHTML = originalButtonHTML;
        } 
    }
    
    async function fetchYiyan() { try { const response = await fetch('https://v1.hitokoto.cn/?encode=json&c=a&c=b&c=c&d&d=i'); if (!response.ok) throw new Error(); const data = await response.json(); yiyanContent.textContent = data.hitokoto; yiyanFrom.textContent = `â€”â€” \( {data.from} \){data.from_who ? 'ï¼ˆ' + data.from_who + 'ï¼‰' : ''}`; } catch (e) { yiyanContent.textContent = 'æ„¿ä½ æœ‰ä¸€å¤©èƒ½ä¸ä½ æœ€é‡è¦çš„äººé‡é€¢ã€‚'; yiyanFrom.textContent = 'â€”â€” æœªçŸ¥'; } }
    async function fetchVisitorCount() { try { await fetch(`${VISITOR_COUNT_API}?text=yunluo_image_bed`); visitorCountElement.textContent = 'æ¬¢è¿è®¿é—®äº‘è½å›¾åºŠ'; } catch (e) { console.error('Visitor count API error:', e); visitorCountElement.textContent = 'è®¿å®¢ç»Ÿè®¡æœåŠ¡è¿æ¥å¤±è´¥'; } }
    function applyTheme(mode) { 
        const icon = themeToggleButton.querySelector('.material-icons'); 
        const isGrayscaleMode = document.body.classList.contains('grayscale-mode');

        if (mode === 'dark') { 
            document.body.classList.add('dark-mode'); 
            icon.textContent = 'light_mode'; 
        } else { 
            document.body.classList.remove('dark-mode'); 
            icon.textContent = 'brightness_2'; 
        } 
        
        // åªæœ‰éæ‚¼å¿µæ¨¡å¼ä¸‹æ‰ä¿å­˜å’Œåˆ‡æ¢å›¾æ ‡
        if (!isGrayscaleMode) {
            localStorage.setItem(THEME_KEY, mode);
        }
    }

    /**
     * ä¿®å¤åçš„æ›´æ–°æ—¥å¿—å¯¹è¯æ¡†ï¼Œå†…å®¹å¯æ»šåŠ¨ï¼Œå¹¶æ·»åŠ äº†æ°´å°åŠŸèƒ½å…¬å‘Š
     */
    function showChangelogDialog() { 
        const content = `<p>æœ¬æ¬¡ç‰ˆæœ¬æ›´æ–°ä¸ºæ‚¨å¸¦æ¥äº†æ›´å¤šçš„é€‰æ‹©å’Œä¾¿åˆ©ï¼š</p><ul>
            <li>ã€ğŸ”¥ æ–°åŠŸèƒ½ v7.9ã€‘<b>è‡ªå®šä¹‰æ°´å°æ·»åŠ </b>ï¼šå‰15æ¬¡ä¸Šä¼ æ”¯æŒè‡ªå®šä¹‰æ°´å°æ–‡æœ¬ï¼ˆå¼¹å‡ºè¾“å…¥æ¡†ï¼‰ã€‚è¶…è¿‡15æ¬¡åï¼ŒæŒ‰é’®ç¦ç”¨ï¼Œå¹¶è‡ªåŠ¨æ·»åŠ å›ºå®šæ°´å°â€œäº‘è½å›¾åºŠ https://jiayuxuan123.rth2.xyz/â€ä»¥å¼•æµï¼ˆæ¬¡æ—¥é‡ç½®ï¼‰ã€‚</li>
            <li>ã€ä¿®å¤ v7.9ã€‘æŒ‰é’®å¤§å°ä¸æ‘†æ”¾ï¼šä¼˜åŒ–ç»“æœåŒºå’Œå†å²è®°å½•æŒ‰é’®çš„flexå¸ƒå±€ï¼Œç¡®ä¿å‡åŒ€åˆ†å¸ƒå’Œå‚ç›´å¯¹é½ã€‚</li>
            <li>ã€ä¿®å¤ v7.7ã€‘åˆ‡æ¢æ¥å£åï¼Œæ¥å£åç§°æ˜¾ç¤ºæœªç«‹å³æ›´æ–°çš„é—®é¢˜ã€‚</li>
            <li>ã€ğŸ”¥ æ–°åŠŸèƒ½ v7.6ã€‘<b>AI å›¾ç‰‡å¢å¼º</b>ï¼šAI å›¾ç‰‡å¢å¼ºå›¾ç‰‡æ–‡ä»¶ï¼ˆéœ€ä¸ºå›¾ç‰‡æ ¼å¼ï¼‰ã€‚æ‚¨å¯ä»¥å¯¹ä¸Šä¼ åçš„å›¾ç‰‡è¿›è¡Œä¸€é”® AI å¢å¼ºï¼Œæå‡å›¾ç‰‡è´¨é‡ã€‚å¢å¼ºåçš„å›¾ç‰‡å°†è‡ªåŠ¨åŠ å…¥å†å²è®°å½•ã€‚</li>
            <li>ã€ğŸ”¥ æ”¹è¿› v7.6ã€‘<b>æ–°å¢â€œæ‰“å¼€â€æŒ‰é’®</b>ï¼šåœ¨ä¸Šä¼ æˆåŠŸç»“æœåŒºå’Œå†å²è®°å½•ä¸­ï¼Œä¸ºå›¾ç‰‡æ–‡ä»¶æ–°å¢â€œæ‰“å¼€â€æŒ‰é’®ï¼Œå¯ç›´æ¥åœ¨æ–°æ ‡ç­¾é¡µä¸­æŸ¥çœ‹å›¾ç‰‡ã€‚</li>
            <li>ã€é‡è¦ä¿®å¤ v7.6ã€‘å†å²è®°å½•æŠ˜å åŠŸèƒ½ï¼š å½»åº•ä¿®å¤äº†ä¸Šä¼ å†å²è®°å½•åˆ—è¡¨çš„æŠ˜å å’Œå±•å¼€åŠ¨ç”»ä¸æµç•…ä»¥åŠæ»šåŠ¨æ¡æ˜¾ç¤ºå¼‚å¸¸çš„é—®é¢˜ã€‚</li>
            <li>ã€v7.4ä¼˜åŒ–ã€‘é»˜è®¤æ¥å£è®°å¿†ï¼šç³»ç»Ÿç°åœ¨ä¼šè‡ªåŠ¨è®°ä½æ‚¨ä¸Šæ¬¡ä½¿ç”¨çš„ä¸Šä¼ æ¥å£ï¼Œæ— éœ€æ¯æ¬¡é‡æ–°é€‰æ‹©ã€‚</li>
            <li>ã€v7.4ä¼˜åŒ–ã€‘æ¥å£é€»è¾‘ä¿®å¤ï¼šä¿®æ­£äº†éƒ¨åˆ†å¤‡ç”¨æ¥å£çš„é“¾æ¥è§£æé€»è¾‘ï¼Œæé«˜äº†ä¸Šä¼ æˆåŠŸç‡ã€‚</li>
            </ul><p style="margin-top: 15px; font-size: 13px;">æ„Ÿè°¢æ‚¨çš„ä½¿ç”¨ï¼æˆ‘ä»¬è‡´åŠ›äºæä¾›ä¸€ä¸ªå®‰å…¨ã€ç¨³å®šã€ä¾¿æ·çš„å›¾åºŠæœåŠ¡ã€‚</p>`; 
        showDialog({ 
            title: `äº‘è½å›¾åºŠ ${CURRENT_APP_VERSION} ç‰ˆæœ¬æ›´æ–°`, 
            content, 
            buttons: [{ text: 'å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†' }],
            scrollable: true // æ ¸å¿ƒä¿®å¤ï¼šå¯ç”¨å†…å®¹æ»šåŠ¨
        }); 
        localStorage.setItem(VERSION_KEY, CURRENT_APP_VERSION); 
    }
    
    // --- æ–°å¢ï¼šå…³é—­æ‚¼å¿µæ¨¡å¼é€»è¾‘ (å·²å‡çº§ä¸ºå¤šäººç‰©æ”¯æŒ) ---
    function closeMemorialMode(figures) {
        // ç”Ÿæˆå½“å‰çºªå¿µäººç‰© ID ç»„åˆçš„å“ˆå¸Œå€¼
        const idHash = sha256(figures.map(f => f.id).sort().join(','));

        showDialog({
            title: 'ç¡®è®¤å…³é—­æ‚¼å¿µæ¨¡å¼',
            content: `<p>å½“å‰å·²è¿›å…¥æ‚¼å¿µæ¨¡å¼ï¼Œä»¥çºªå¿µ <b>\( {figures.map(f => f.name).join('ã€')}</b> ç­‰äººç‰©ã€‚</p><p>å…³é—­åï¼Œæ¨ªå¹…å°†æ¶ˆå¤±ï¼Œä¸”å¦‚æœå¼€å¯äº†ç°è‰²æ¨¡å¼ï¼Œé¡µé¢å°†æ¢å¤å½©è‰²ã€‚æœ¬æ¬¡å…³é—­çŠ¶æ€ï¼ˆå“ˆå¸Œå€¼ï¼š<code> \){idHash.substring(0, 10)}...</code>ï¼‰å°†ä¿å­˜ã€‚åœ¨å½“å‰çºªå¿µæ—¥å†…ï¼Œæ¨ªå¹…å°†ä¸å†æ˜¾ç¤ºã€‚ä½†å¦‚æœä¸‹ä¸€ä¸ªçºªå¿µæ—¥çš„äººç‰©ç»„åˆå‘ç”Ÿå˜åŒ–ï¼Œæ¨ªå¹…ä»ä¼šæŒ‰ç…§æ–°ç»„åˆçš„è®¾ç½®æ˜¾ç¤ºã€‚</p><p><b>æ‚¨ç¡®å®šè¦å…³é—­æ‚¼å¿µæ¨¡å¼å—ï¼Ÿ</b></p>`,
            buttons: [
                { text: 'å–æ¶ˆ' },
                { text: 'ç¡®å®šå…³é—­', onClick: () => {
                    localStorage.setItem(MEMORIAL_CLOSED_KEY, idHash);
                    // ç§»é™¤æ‰€æœ‰æ‚¼å¿µæ¨¡å¼çš„å½±å“
                    document.body.classList.remove('grayscale-mode');
                    memorialBanner.style.display = 'none';
                    themeToggleButton.disabled = false;
                    
                    // æ¢å¤æ­£å¸¸ä¸»é¢˜
                    const savedTheme = localStorage.getItem(THEME_KEY);
                    applyTheme(savedTheme || 'light');
                    
                    showSnackbar('æ‚¼å¿µæ¨¡å¼å·²å…³é—­ï¼Œé¡µé¢æ¢å¤æ­£å¸¸æ˜¾ç¤ºã€‚');
                }}
            ]
        });
    }
    
    // --- æ–°å¢ï¼šæ˜¾ç¤ºå¤šäººç‰©åˆ—è¡¨çš„å¼¹çª— (å‡çº§ç‰ˆï¼Œæ”¯æŒæ˜¾ç¤ºdescriptionã€yearsç­‰ç»†èŠ‚) ---
    function showMultipleMemorialDialog(figures) {
        let listHtml = '<ul>';
        figures.forEach(f => {
            const date = f.memorialDates[0]; // å‡è®¾ç¬¬ä¸€ä¸ªæ—¥æœŸä¸ºä¸»è¦çºªå¿µæ—¥
            const reason = date.type || 'ç¦»ä¸–'; // ä½¿ç”¨ type ä½œä¸º reason
            listHtml += `<li>
                <b>\( {f.name}</b> ( \){f.years})<br>
                <span style="font-size: 14px; color: var(--md-sys-color-on-surface-variant);">æè¿°ï¼š${f.description || 'æ— è¯¦ç»†æè¿°'}</span><br>
                <span style="font-size: 14px; color: var(--md-sys-color-on-surface-variant);">çºªå¿µæ—¥æœŸï¼š\( {date.month}æœˆ \){date.day}æ—¥ï¼ˆ${reason}ï¼‰</span>
            </li>`;
        });
        listHtml += '</ul>';

        showDialog({
            title: 'ä»Šæ—¥çºªå¿µäººç‰©åˆ—è¡¨',
            content: `<p>ä»Šæ—¥æ˜¯ä»¥ä¸‹ \( {figures.length} ä½äººç‰©çš„çºªå¿µæ—¥ï¼š</p> \){listHtml}<p>æ‚¨å¯ä»¥é€šè¿‡å³ä¾§çš„ <i class="material-icons" style="font-size: 16px; vertical-align: middle;">close</i> æŒ‰é’®å…³é—­æ‚¼å¿µæ¨¡å¼ã€‚</p>`,
            buttons: [
                { text: 'çŸ¥é“äº†' },
            ],
            scrollable: true
        });
    }
    // --- å…³é—­æ‚¼å¿µæ¨¡å¼é€»è¾‘ END ---

    // --- çºªå¿µäººç‰©ç³»ç»Ÿé€»è¾‘ (å·²æ›´æ–°ï¼Œæ”¯æŒå¤šäººç‰©) ---
    function initMemorialSystem() {
        if (typeof memorialFigures === 'undefined' || !memorialFigures.length) {
            return;
        }

        const today = new Date();
        const month = today.getMonth() + 1; // 1-based month
        const day = today.getDate();
        
        // 1. æ”¶é›†æ‰€æœ‰å½“æ—¥çš„çºªå¿µäººç‰©
        const foundMemorials = memorialFigures.filter(figure => 
            figure.memorialDates.some(date => 
                date.month === month && date.day === day
            )
        );
        
        todayMemorialFigures = foundMemorials; // ä¿å­˜åˆ°å…¨å±€å˜é‡

        // 2. å¦‚æœæ²¡æœ‰çºªå¿µäººç‰©ï¼Œåˆ™é€€å‡º
        if (foundMemorials.length === 0) {
            document.body.classList.remove('grayscale-mode');
            memorialBanner.style.display = 'none';
            themeToggleButton.disabled = false;
            localStorage.removeItem(MEMORIAL_CLOSED_KEY); // æ¸…é™¤æ—§çŠ¶æ€
            return;
        }

        // 3. ç”Ÿæˆå½“å‰äººç‰© ID ç»„åˆçš„å“ˆå¸Œå€¼
        const currentIdHash = sha256(foundMemorials.map(f => f.id).sort().join(','));
        const memorialClosedHash = localStorage.getItem(MEMORIAL_CLOSED_KEY);

        // 4. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²é’ˆå¯¹æ­¤äººç‰©ç»„åˆå…³é—­è¿‡æ‚¼å¿µæ¨¡å¼
        if (memorialClosedHash === currentIdHash) {
            console.log(`Memorial mode for hash ${currentIdHash.substring(0, 10)}... was previously closed by user.`);
            return; // é€€å‡ºï¼Œä¸åº”ç”¨æ‚¼å¿µæ¨¡å¼
        }

        // 5. åº”ç”¨æ‚¼å¿µæ¨¡å¼
        
        // a. å¤„ç†æ¨ªå¹…å†…å®¹
        const primaryFigure = foundMemorials[0];
        let bannerText = primaryFigure.bannerText;
        if (foundMemorials.length > 1) {
            bannerText += ` ...ï¼ˆå¦æœ‰ ${foundMemorials.length - 1} ä½äººç‰©ï¼‰`;
            $('#memorialIcon').style.display = 'inline'; // Show icon for multiple
        } else {
            $('#memorialIcon').style.display = 'none';
        }
        memorialBannerText.textContent = bannerText;
        memorialBanner.style.display = 'flex';
        closeMemorialButton.style.display = 'block';

        // b. åº”ç”¨è‡ªå®šä¹‰æ ·å¼
        for (const prop in primaryFigure.bannerStyle) {
            memorialBanner.style[prop] = primaryFigure.bannerStyle[prop];
        }

        // c. ç‰¹æ®Šå¤„ç†ï¼šç°è‰²æ¨¡å¼
        if (foundMemorials.some(f => f.id === 'yangzhenning')) { // åªè¦æœ‰ä¸€ä¸ªäººç‰©éœ€è¦å¼ºåˆ¶ç°è‰²å°±åº”ç”¨
            document.body.classList.add('grayscale-mode');
            themeToggleButton.disabled = true; 
            themeToggleButton.querySelector('.material-icons').textContent = 'dark_mode';
            if (!localStorage.getItem('yunluo_grayscale_tip_shown')) {
                showSnackbar(`å·²è¿›å…¥ã€æ²‰ç—›æ‚¼å¿µã€‘æ¨¡å¼ï¼Œä¸»é¢˜åˆ‡æ¢åŠŸèƒ½æš‚æ—¶ç¦ç”¨ã€‚`);
                localStorage.setItem('yunluo_grayscale_tip_shown', 'true');
            }
        } else {
            document.body.classList.remove('grayscale-mode');
            themeToggleButton.disabled = false;
        }
        
        // d. æ¢å¤æ­£å¸¸ä¸»é¢˜å›¾æ ‡ï¼ˆå¦‚æœä¸æ˜¯ç°è‰²æ¨¡å¼ï¼‰
        if (!document.body.classList.contains('grayscale-mode')) {
            const savedTheme = localStorage.getItem(THEME_KEY);
            applyTheme(savedTheme || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
        }
    }
    // --- çºªå¿µäººç‰©ç³»ç»Ÿé€»è¾‘ END ---
    
    // Lightbox Function
    function showLightbox(src) {
        const overlay = document.createElement('div');
        overlay.className = 'lightbox-overlay';
        const img = document.createElement('img');
        img.src = src;
        img.style.maxWidth = '90%';
        img.style.maxHeight = '90%';
        overlay.appendChild(img);
        document.body.appendChild(overlay);
        overlay.addEventListener('click', () => overlay.remove());
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        
        // æ ¸å¿ƒï¼šåœ¨DOMåŠ è½½å®Œæˆåç«‹å³æ£€æŸ¥å¹¶åº”ç”¨çºªå¿µæ¨¡å¼
        initMemorialSystem();
        
        // åˆå§‹åŒ–ä»Šæ—¥ä¸Šä¼ è®¡æ•°
        todayUploadCount = getTodayUploadCount();
        updateWatermarkUI();
        
        // æ­£å¸¸ä¸»é¢˜åˆå§‹åŒ–é€»è¾‘ï¼ˆä»…åœ¨éæ‚¼å¿µæ—¥ç”Ÿæ•ˆï¼‰
        const isGrayscaleMode = document.body.classList.contains('grayscale-mode');
        if (!isGrayscaleMode) {
            const savedTheme = localStorage.getItem(THEME_KEY), prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
        }

        const savedApi = localStorage.getItem(API_PREFERENCE_KEY);
        if (savedApi && API_CONFIG[savedApi]) { apiSelector.value = savedApi; } else { apiSelector.value = 'yanxuan'; }
        
        fetchYiyan(); loadHistory(); updateApiSelectionUI(); handleFormatChange(currentUrlFormat); fetchVisitorCount();
        if (localStorage.getItem(VERSION_KEY) !== CURRENT_APP_VERSION) { showChangelogDialog(); }
        
        // å¦‚æœå†å²è®°å½•ä¸­æ²¡æœ‰æ–‡ä»¶ï¼Œå¼ºåˆ¶æŠ˜å 
        if ($('#historyEmptyTip')) { setHistoryCollapseState(true); }

        apiSelectorButton.addEventListener('click', showApiSelectorDialog);
        imageUpload.addEventListener('change', e => handleFileSelect(e.target.files[0]));
        uploadButton.addEventListener('click', uploadFile); 
        refreshYiyanButton.addEventListener('click', fetchYiyan); 
        clearHistoryButton.addEventListener('click', clearAllHistory); 
        
        // æ–°å¢ï¼šæ°´å°æŒ‰é’®äº‹ä»¶
        addWatermarkButton.addEventListener('click', handleAddWatermark);
        
        // è°ƒæ•´ä¸»é¢˜åˆ‡æ¢é€»è¾‘ï¼Œåœ¨æ‚¼å¿µæ—¥ç¦ç”¨
        themeToggleButton.addEventListener('click', () => {
            if (!document.body.classList.contains('grayscale-mode')) {
                applyTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark');
            } else {
                showSnackbar('æ‚¼å¿µæ—¥å·²å¯ç”¨ç°è‰²æ¨¡å¼ï¿½ï¿½ï¿½ä¸»é¢˜åˆ‡æ¢æš‚æ—¶ç¦ç”¨ã€‚');
            }
        });
        
        // æ–°å¢ï¼šå…³é—­æ‚¼å¿µæ¨¡å¼æŒ‰é’®æŒ‰é’®äº‹ä»¶ (ä½¿ç”¨ todayMemorialFigures)
        closeMemorialButton.addEventListener('click', (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œä»¥å…å¹²æ‰°å…¶ä»–ç‚¹å‡»äº‹ä»¶
            if (todayMemorialFigures.length > 0) {
                closeMemorialMode(todayMemorialFigures);
            }
        });

        // æ–°å¢ï¼šåŒå‡»æ¨ªï¿½ï¿½æ˜¾ç¤ºå¤šäººç‰©åˆ—è¡¨
        memorialBanner.addEventListener('dblclick', () => {
            if (todayMemorialFigures.length > 0) {
                showMultipleMemorialDialog(todayMemorialFigures);
            }
        });
        
        // ä¿®å¤: å†å²è®°å½•åˆ‡æ¢é€»è¾‘
        toggleHistoryButton.addEventListener('click', () => setHistoryCollapseState(!historyList.classList.contains('hidden')));
        
        // Grid View Toggle
        historyViewToggle.addEventListener('click', () => {
            historyList.classList.toggle('grid');
            const icon = historyViewToggle.querySelector('.material-icons');
            icon.textContent = historyList.classList.contains('grid') ? 'view_list' : 'grid_view';
        });
        
        copyUrlButton.addEventListener('click', () => {
            copyToClipboard(resultUrlDisplay.textContent, `å·²å¤åˆ¶ ${currentUrlFormat.toUpperCase()} æ ¼å¼é“¾æ¥`);
            const icon = copyUrlButton.querySelector('.material-icons');
            const originalIcon = icon.textContent;
            icon.textContent = 'check';
            setTimeout(() => { icon.textContent = originalIcon; }, 1000);
        });
        enhanceImageButton.addEventListener('click', () => {
            if (uploadedUrl && selectedFile) {
                const isImage = selectedFile.type.startsWith('image/');
                if (isImage) {
                    enhanceImage(uploadedUrl, selectedFile.name);
                } else {
                     showSnackbar('AI å¢å¼ºä»…æ”¯æŒå›¾ç‰‡æ–‡ä»¶');
                }
            }
        });
        
        urlFormatSelector.querySelectorAll('.chip').forEach(chip => { chip.addEventListener('click', function() { handleFormatChange(this.dataset.format); }); });
        ['dragenter','dragover','dragleave','drop'].forEach(eName=>uploadArea.addEventListener(eName, e=>{e.preventDefault();e.stopPropagation();}, false));
        ['dragenter','dragover'].forEach(eName=>uploadArea.addEventListener(eName, ()=>{ uploadArea.classList.add('dragover'); uploadTip.textContent = 'æ¾å¼€å³å¯é€‰æ‹©æ–‡ä»¶'; }, false));
        ['dragleave','drop'].forEach(eName=>uploadArea.addEventListener(eName, ()=>{ uploadArea.classList.remove('dragover'); uploadTip.textContent = selectedFile ? `æ–‡ä»¶å·²å°±ç»ª: ${truncateFilename(selectedFile.name, 28)}` : 'æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–'; }, false));
        uploadArea.addEventListener('drop', e => handleFileSelect(e.dataTransfer.files[0]));
        
        // History Interactions including Swipe
        historyList.addEventListener('click', e => {
            const target = e.target;
            const deleteBtn = target.closest('.delete-button');
            const enhanceBtn = target.closest('.enhance-button');
            const watermarkBtn = target.closest('.watermark-button');
            const openBtn = target.closest('.open-button');
            const copyArea = target.closest('.history-item-info, .history-item-thumb');
            const swipeDel = target.closest('.swipe-delete');
            
            if (deleteBtn || swipeDel) { 
                const item = target.closest('.history-item');
                const { url, name } = item.dataset; 
                showDialog({ 
                    title: 'ç¡®è®¤åˆ é™¤', 
                    content: `ç¡®å®šè¦åˆ é™¤ "${name}" å—ï¼Ÿ`, 
                    buttons: [
                        { text: 'å–æ¶ˆ' },
                        { text: 'ç¡®å®š', onClick: () => deleteHistoryItem(url) }
                    ] 
                });
            } else if (enhanceBtn) { 
                const { url, name } = enhanceBtn.dataset; 
                enhanceImage(url, name);
            } else if (watermarkBtn) {
                const { url, name } = watermarkBtn.dataset;
                showCustomWatermarkDialog(url, name);
            } else if (openBtn) { 
                const { url } = openBtn.dataset;
                window.open(url, '_blank');
            } else if (copyArea) { 
                const { url, name } = copyArea.parentElement.querySelector('.history-item-info').dataset; 
                copyToClipboard(getFormattedUrl(url, name, 'url'), 'å†å²æ–‡ä»¶ URL å·²å¤åˆ¶'); 
            } else if (target.closest('.history-item-thumb')) {
                const src = target.src;
                if (src) showLightbox(src);
            }
        });
        
        // Swipe Gesture for Mobile
        historyList.addEventListener('touchstart', e => {
            const item = e.target.closest('.history-item');
            if (!item) return;
            let startX = e.touches[0].clientX;
            const moveHandler = e => {
                const deltaX = e.touches[0].clientX - startX;
                if (deltaX < -50) {
                    item.style.transform = `translateX(${deltaX}px)`;
                    item.classList.add('swiped');
                }
            };
            const endHandler = () => {
                item.style.transform = '';
                item.classList.remove('swiped');
                item.removeEventListener('touchmove', moveHandler);
                item.removeEventListener('touchend', endHandler);
            };
            item.addEventListener('touchmove', moveHandler);
            item.addEventListener('touchend', endHandler);
        });
        
        // FAB Click
        fab.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            imageUpload.click();
        });
        
        // Lightbox for Preview
        imagePreview.addEventListener('click', () => {
            if (imagePreview.src) showLightbox(imagePreview.src);
        });
    });
</script>

<!-- Vercel Speed Insights -->
<script>
    window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
</script>
<script defer src="/_vercel/speed-insights/script.js"></script>

</body>
</html>